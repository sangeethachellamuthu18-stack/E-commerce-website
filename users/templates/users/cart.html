{% extends "users/base.html" %}
{% load static %}

{% block content %}
    <section class="cart-section">
        <h2>Your Shopping Cart</h2>

        <div class="cart-container">
            {% if cart_items %}
                <div class="cart-items">
                    {% for item in cart_items %}
                        <div class="cart-item" data-item-id="{{ item.id }}">
                            <div class="item-image">
                                <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                            </div>

                            <div class="item-details">
                                <h3>{{ item.product.name }}</h3>
                                <p class="price">₹{{ item.product.price }}</p>

                                <div class="quantity-controls">
                                    <button class="quantity-btn minus" data-action="decrease">-</button>
                                    <span class="quantity">{{ item.quantity }}</span>
                                    <button class="quantity-btn plus" data-action="increase">+</button>
                                </div>

                                <p class="subtotal">Subtotal: ₹{{ item.subtotal }}</p>
                            </div>

                            <button class="btn remove-from-cart" data-item-id="{{ item.id }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    {% endfor %}
                </div>

                <div class="cart-summary">
                    <h3>Order Summary</h3>
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span>₹{{ cart_total }}</span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping:</span>
                        <span>₹{{ shipping_cost }}</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span>₹{{ grand_total }}</span>
                    </div>
                    <a href="{% url 'checkout' %}" class="btn checkout-btn">Proceed to Checkout</a>
                </div>
            {% else %}
                <p class="empty-cart">Your cart is empty.</p>
                <a href="{% url 'users_dashboard' %}" class="btn continue-shopping">Continue Shopping</a>
            {% endif %}
        </div>
    </section>

    <script>
        // Quantity controls
        document.querySelectorAll('.quantity-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const itemId = this.closest('.cart-item').getAttribute('data-item-id');
                const action = this.getAttribute('data-action');
                const quantityElement = this.parentElement.querySelector('.quantity');

                try {
                    const response = await fetch(`/cart/update/${itemId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}',
                        },
                        body: JSON.stringify({
                            action: action
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        quantityElement.textContent = data.new_quantity;
                        // You may want to update totals here with another AJAX call
                        if (data.new_quantity < 1) {
                            this.closest('.cart-item').remove();
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            });
        });

        // Remove from cart
        document.querySelectorAll('.remove-from-cart').forEach(button => {
            button.addEventListener('click', async function() {
                const itemId = this.getAttribute('data-item-id');

                try {
                    const response = await fetch(`/cart/remove/${itemId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                        }
                    });

                    if (response.ok) {
                        this.closest('.cart-item').remove();
                        if (!document.querySelector('.cart-item')) {
                            document.querySelector('.cart-container').innerHTML = `
                                <p class="empty-cart">Your cart is empty.</p>
                                <a href="{% url 'users_dashboard' %}" class="btn continue-shopping">Continue Shopping</a>
                            `;
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            });
        });
    </script>
{% endblock %}